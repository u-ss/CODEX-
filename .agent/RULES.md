# ⛔ 強制ルール（user_rules）

> [!CAUTION]
> **このルールは絶対に守ること。違反は許されない。**

## 1. ワークフロー実行の強制手順

`/xxx` コマンドを受けたら:

1. **SKILL.md を読む**: `.agent/workflows/xxx/SKILL.md`（ルール・禁止事項）
2. **WORKFLOW.md を読む**: `.agent/workflows/xxx/WORKFLOW.md`（実行手順）
3. **実行開始**: 上記を読んでから初めて実行

**Phase飛ばし禁止**: 各Phaseを順次実行すること。

### デフォルト入口ルール（重要）

- **明示的な `/xxx` 指定がない依頼は、原則 `/orchestrator_pm` を最初に使う**
- `/orchestrator_pm` で `ROADMAP / TASK LIST / Dispatch Queue` を確定してから、割当先ワークフロー（例: `/code`, `/research`, `/desktop`）を実行する
- 例外（直接実行可）:
  - ユーザーが実行ワークフローを明示している
  - 単一・軽微で分解不要な依頼（例: 単発の説明、軽微な確認）
  - 継続作業で、既に実行ワークフローが確定済み

---

## 2. ツール使用制限

### ❌ 禁止ツール

| ツール | 状況 | 理由 |
|--------|------|------|
| `browser_subagent` | `/desktop` タスク | BOT判定される |

### ✅ 推奨ツール

| タスク | 推奨ツール |
|--------|-----------|
| ブラウザDOM操作 | Playwright + CDP (`connect_over_cdp`) |
| ウィンドウ操作 | Pywinauto (UIA) |
| 座標操作（最後の手段） | PyAutoGUI |

---

## 3. リサーチ時の検索ログ出力（必須）

> [!IMPORTANT]
> `/research` またはリサーチ系の作業を実行した場合、**完了時にsearch_log.mdを必ず出力**すること。

| 項目 | 内容 |
|:-----|:-----|
| **出力タイミング** | レポート出力と同時（Phase 4完了時） |
| **保存先** | `_outputs/research/YYYYMMDD_HHMM/search_log.md` |
| **必須記載項目** | 検索クエリ一覧、ジャンル分類、主要参照ソース、参照件数、統計 |
| **対象** | Antigravity直接実行・スクリプト経由ともに対象 |

---

## 4. 実行前チェックリスト

ワークフロー実行前に必ず確認:

```
□ SKILL.md を読んだ
□ WORKFLOW.md を読んだ
□ 禁止ツールを使おうとしていない
□ Phase順序を理解した
□ リサーチ系タスクの場合、search_log.md出力を計画に含めた
```

---

## 5. 違反時の対応

1. 即座に停止
2. ユーザーに報告
3. 正しい手順からやり直し

---

## 6. エージェント配置ルール

新しいエージェントを作成する際は **2層構造** で配置する:

### ディレクトリ構成

```
antigravity/
├── .agent/workflows/{名前}/   ← 論理層（ワークフロー定義）
│   ├── WORKFLOW.md            ← 必須: 実行手順
│   └── SKILL.md               ← 必須: 技術詳細
│
└── エージェント/{名前}/        ← 物理層（ツール・スクリプト）
    ├── scripts/               ← 実行スクリプト
    └── ...                    ← その他リソース
```

### 必須事項

| 層 | 必須ファイル | 内容 |
|----|-------------|------|
| **論理層** (`.agent/workflows/`) | `WORKFLOW.md` | 実行手順（チェックリスト） |
| **論理層** (`.agent/workflows/`) | `SKILL.md` | 技術詳細・コード例 |
| **物理層** (`エージェント/`) | スクリプト類 | 実際のツール実装 |

### 命名規則

- **ワークフロー名**: 英小文字 + アンダースコア（例: `desktop`, `research_deep`）
- **エージェントフォルダ名**: 日本語OK（例: `デスクトップ操作エージェント`）

### ⛔ 実装ルール（例外なし）

> [!CAUTION]
> **違反時は即座に作業を中止し、`/code`からやり直すこと。**

以下の作業は **必ず `/code` ワークフローを読んでから** 実行する：

| 対象 | `/code` 必須 |
|------|:------------:|
| スクリプト実装（.py等） | ✅ 必須 |
| WORKFLOW.md の作成・編集 | ✅ 必須 |
| SKILL.md の作成・編集 | ✅ 必須 |

**手順**:
1. `.agent/workflows/code/SKILL.md` を読む
2. `.agent/workflows/code/WORKFLOW.md` を読む
3. 実行開始

---
